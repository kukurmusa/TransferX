{% extends "base.html" %}

{% block title %}Offers | TransferX{% endblock %}

{% block page_title %}<h1 class="text-2xl font-semibold text-white">{{ view_title }}</h1>{% endblock %}
{% block page_subtitle %}<p class="text-sm text-slate-400">Offer inbox</p>{% endblock %}

{% block content %}
  {# Tab switcher #}
  <div class="mb-6 flex items-center gap-2">
    <a class="rounded-lg px-3 py-1.5 text-sm font-medium transition-colors no-underline
      {% if 'received' in request.path %}bg-emerald-500/10 text-emerald-400 ring-1 ring-emerald-500/30{% else %}text-slate-400 hover:text-white hover:bg-white/5 ring-1 ring-white/10{% endif %}"
       href="{% url 'marketplace:offer_received' %}">Received</a>
    <a class="rounded-lg px-3 py-1.5 text-sm font-medium transition-colors no-underline
      {% if 'sent' in request.path %}bg-emerald-500/10 text-emerald-400 ring-1 ring-emerald-500/30{% else %}text-slate-400 hover:text-white hover:bg-white/5 ring-1 ring-white/10{% endif %}"
       href="{% url 'marketplace:offer_sent' %}">Sent</a>
  </div>

  {% if page_obj.object_list %}
    <div class="space-y-8">
      <div class="space-y-4">
        <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-300">Needs your response</h2>
        {% for card in grouped_offers.needs_response %}
          {% url 'marketplace:offer_detail' card.offer.id as offer_url %}
          <a href="{{ offer_url }}" class="block rounded-2xl border {% if card.unread %}border-emerald-400/60{% else %}border-white/10{% endif %} bg-slate-900/70 p-5 transition hover:-translate-y-1 hover:border-white/20">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div>
                <div class="text-lg font-semibold text-white">{{ card.offer.player.name }}</div>
                <div class="text-sm text-slate-400">
                  {% if card.counterparty %}{{ card.counterparty.name }}{% else %}Free agent{% endif %}
                </div>
                <div class="mt-1 text-xs text-slate-500">
                  Fee GBP {{ card.latest_fee|default:"-" }} - Wage GBP {{ card.latest_wage|default:"-" }}
                </div>
              </div>
              <div class="text-right text-xs text-slate-500">
                <div>Last activity {{ card.last_action_at|timesince }} ago</div>
                {% if card.expires_at %}
                  <div class="mt-1 text-amber-200">Expires in {{ card.expires_at|timeuntil }}</div>
                {% endif %}
              </div>
            </div>
            <div class="mt-4 border-t border-white/10 pt-4 text-sm text-slate-400">
              {% if card.last_message %}"{{ card.last_message.body|truncatechars:120 }}"{% else %}No messages yet.{% endif %}
            </div>
          </a>
        {% empty %}
          <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 text-sm text-slate-400">No offers need your response.</div>
        {% endfor %}
      </div>

      <div class="space-y-4">
        <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Awaiting reply</h2>
        {% for card in grouped_offers.awaiting_reply %}
          {% url 'marketplace:offer_detail' card.offer.id as offer_url %}
          <a href="{{ offer_url }}" class="block rounded-2xl border border-white/10 bg-slate-900/70 p-5 transition hover:-translate-y-1 hover:border-white/20">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div>
                <div class="text-lg font-semibold text-white">{{ card.offer.player.name }}</div>
                <div class="text-sm text-slate-400">
                  {% if card.counterparty %}{{ card.counterparty.name }}{% else %}Free agent{% endif %}
                </div>
                <div class="mt-1 text-xs text-slate-500">
                  Fee GBP {{ card.latest_fee|default:"-" }} - Wage GBP {{ card.latest_wage|default:"-" }}
                </div>
              </div>
              <div class="text-right text-xs text-slate-500">
                <div>Last activity {{ card.last_action_at|timesince }} ago</div>
                {% if card.expires_at %}
                  <div class="mt-1 text-amber-200">Expires in {{ card.expires_at|timeuntil }}</div>
                {% endif %}
              </div>
            </div>
            <div class="mt-4 border-t border-white/10 pt-4 text-sm text-slate-400">
              {% if card.last_message %}"{{ card.last_message.body|truncatechars:120 }}"{% else %}No messages yet.{% endif %}
            </div>
          </a>
        {% empty %}
          <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 text-sm text-slate-400">No offers awaiting reply.</div>
        {% endfor %}
      </div>

      <div class="space-y-4">
        <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Closed</h2>
        {% for card in grouped_offers.closed %}
          {% url 'marketplace:offer_detail' card.offer.id as offer_url %}
          <a href="{{ offer_url }}" class="block rounded-2xl border border-white/10 bg-slate-900/70 p-5 transition hover:-translate-y-1 hover:border-white/20">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div>
                <div class="text-lg font-semibold text-white">{{ card.offer.player.name }}</div>
                <div class="text-sm text-slate-400">
                  {% if card.counterparty %}{{ card.counterparty.name }}{% else %}Free agent{% endif %}
                </div>
                <div class="mt-1 text-xs text-slate-500">
                  Fee GBP {{ card.latest_fee|default:"-" }} - Wage GBP {{ card.latest_wage|default:"-" }}
                </div>
              </div>
              <div class="text-right text-xs text-slate-500">
                <div>Status {{ card.offer.get_status_display }}</div>
                <div class="mt-1">Last activity {{ card.last_action_at|timesince }} ago</div>
              </div>
            </div>
            <div class="mt-4 border-t border-white/10 pt-4 text-sm text-slate-400">
              {% if card.last_message %}"{{ card.last_message.body|truncatechars:120 }}"{% else %}No messages yet.{% endif %}
            </div>
          </a>
        {% empty %}
          <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-5 text-sm text-slate-400">No closed offers.</div>
        {% endfor %}
      </div>
    </div>
  {% else %}
    {% include "components/empty_state.html" with title="No offers" description="Your inbox is empty." %}
  {% endif %}

  {% if page_obj.paginator.num_pages > 1 %}
    <div class="mt-6 flex items-center justify-between text-sm text-slate-500">
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-slate-300 ring-1 ring-white/10 hover:bg-slate-700 no-underline" href="?page={{ page_obj.previous_page_number }}">Prev</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-slate-300 ring-1 ring-white/10 hover:bg-slate-700 no-underline" href="?page={{ page_obj.next_page_number }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}
