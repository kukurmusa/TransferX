{% extends "base.html" %}

{% block title %}Offer {{ offer.id }} | TransferX{% endblock %}

{% block page_title %}<h1 class="text-2xl font-semibold text-white">{{ offer.player.name }}</h1>{% endblock %}
{% block page_subtitle %}<p class="text-sm text-slate-400">Offer details</p>{% endblock %}
{% block page_actions %}
  {% include "components/badge.html" with text=offer.get_status_display variant="neutral" size="sm" %}
{% endblock %}

{% block content %}
  <div class="grid gap-6 lg:grid-cols-[3fr_2fr]">
    {# ── Left column: offer details + negotiation thread ── #}
    <div class="space-y-6">

      {# Offer summary card #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <div class="text-lg font-semibold text-white">{{ offer.player.name }}</div>
            <div class="text-sm text-slate-400">
              From {{ offer.from_club.club_name }} to {% if offer.to_club %}{{ offer.to_club.club_name }}{% else %}Free agent{% endif %}
            </div>
            <div class="mt-1 text-xs text-slate-500">You are the {{ role|lower }}</div>
          </div>
        </div>
        <div class="mt-4 grid gap-3 sm:grid-cols-3">
          <div class="rounded-lg bg-slate-800/60 p-3">
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Fee</div>
            <div class="mt-1 text-sm font-semibold text-white">GBP {{ offer.fee_amount|default:"-" }}</div>
          </div>
          <div class="rounded-lg bg-slate-800/60 p-3">
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Wage (weekly)</div>
            <div class="mt-1 text-sm font-semibold text-white">GBP {{ offer.wage_weekly|default:"-" }}</div>
          </div>
          <div class="rounded-lg bg-slate-800/60 p-3">
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Contract</div>
            <div class="mt-1 text-sm font-semibold text-white">{% if offer.contract_years %}{{ offer.contract_years }} years{% else %}-{% endif %}</div>
          </div>
        </div>
        <div class="mt-3 text-sm text-slate-500">
          {% if offer.expires_at %}Expires {{ offer.expires_at|date:"M d, H:i" }}{% else %}No expiry{% endif %}
        </div>
      </div>

      {# Negotiation thread — chat bubbles #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <h2 class="text-lg font-semibold text-white">Negotiation</h2>
        <div class="mt-4 space-y-4">
          {% for message in messages %}
            {% if message.sender_club and message.sender_club.id == offer.from_club_id %}
              {# Left bubble — from_club #}
              <div class="flex justify-start">
                <div class="max-w-[80%] rounded-xl rounded-bl-none bg-slate-800 px-4 py-3">
                  <div class="text-xs font-medium text-emerald-400">
                    {{ message.sender_club.club_name }}
                    <span class="ml-2 font-normal text-slate-500">{{ message.created_at|date:"M d, H:i" }}</span>
                  </div>
                  <div class="mt-1 text-sm text-slate-300">{{ message.body }}</div>
                </div>
              </div>
            {% else %}
              {# Right bubble — to_club or other #}
              <div class="flex justify-end">
                <div class="max-w-[80%] rounded-xl rounded-br-none bg-emerald-500/10 px-4 py-3 ring-1 ring-emerald-500/20">
                  <div class="text-xs font-medium text-emerald-400">
                    {% if message.sender_club %}{{ message.sender_club.club_name }}{% else %}{{ message.sender_user.username }}{% endif %}
                    <span class="ml-2 font-normal text-slate-500">{{ message.created_at|date:"M d, H:i" }}</span>
                  </div>
                  <div class="mt-1 text-sm text-slate-300">{{ message.body }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="text-sm text-slate-500">No messages yet. Start the negotiation.</div>
          {% endfor %}
        </div>

        <form method="post" action="{% url 'marketplace:offer_message' offer.id %}" class="mt-4 flex gap-3">
          {% csrf_token %}
          <div class="flex-1">{{ message_form.body }}</div>
          {% include "components/button.html" with text="Send" variant="primary" size="sm" %}
        </form>
      </div>

      {# Timeline #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <h2 class="text-lg font-semibold text-white">Timeline</h2>
        <div class="mt-4">
          {% if events %}
            {% include "components/timeline.html" with events=events %}
          {% else %}
            <div class="text-sm text-slate-500">No events yet.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── Right column: actions + scouting + counter ── #}
    <div class="space-y-6 lg:sticky lg:top-6 lg:self-start">

      {# Actions #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <h2 class="text-lg font-semibold text-white">Actions</h2>
        <div class="mt-4 space-y-3">
          {% if club.id == offer.from_club_id %}
            {% if offer.status == "DRAFT" or offer.status == "SENT" or offer.status == "COUNTERED" %}
              <form method="post" action="{% url 'marketplace:offer_withdraw' offer.id %}">
                {% csrf_token %}
                {% include "components/button.html" with text="Withdraw" variant="danger" size="sm" extra_classes="w-full" %}
              </form>
            {% endif %}
          {% endif %}

          {% if club.id == offer.to_club_id %}
            {% if offer.status == "SENT" or offer.status == "COUNTERED" %}
              <form method="post" action="{% url 'marketplace:offer_accept' offer.id %}">
                {% csrf_token %}
                {% include "components/button.html" with text="Accept" variant="primary" size="sm" extra_classes="w-full" %}
              </form>
              <form method="post" action="{% url 'marketplace:offer_reject' offer.id %}">
                {% csrf_token %}
                {% include "components/button.html" with text="Reject" variant="ghost" size="sm" extra_classes="w-full" %}
              </form>
            {% endif %}
          {% endif %}

          {% if not club.id == offer.from_club_id and not club.id == offer.to_club_id %}
            <div class="text-sm text-slate-500">No actions available.</div>
          {% endif %}
        </div>
      </div>

      {# Scouting #}
      {% if can_scout %}
        <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
          <h2 class="text-lg font-semibold text-white">Scouting</h2>
          <div class="mt-3">
            {% include "scouting/_interest_badge.html" with interest=interest %}
          </div>
          <form method="post" action="{% url 'scouting:interest_set' %}" class="mt-4">
            {% csrf_token %}
            <input type="hidden" name="player_id" value="{{ offer.player.id }}" />
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <input type="hidden" name="level" value="PRIORITY" />
            <input type="hidden" name="stage" value="NEGOTIATING" />
            {% include "components/button.html" with text="Set negotiating" variant="secondary" size="sm" extra_classes="w-full" %}
          </form>
          <div class="mt-4 text-xs text-slate-500">Add to shortlist</div>
          {% include "scouting/_shortlist_dropdown.html" with player=offer.player shortlists=shortlists next_url=request.get_full_path can_scout=can_scout %}
        </div>
      {% endif %}

      {# Counter offer #}
      {% if offer.status == "SENT" or offer.status == "COUNTERED" %}
        <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
          <h2 class="text-lg font-semibold text-white">Counter offer</h2>
          <form method="post" action="{% url 'marketplace:offer_counter' offer.id %}" class="mt-4 space-y-3">
            {% csrf_token %}
            {% include "components/form/field.html" with field=offer_counter_form.fee_amount %}
            {% include "components/form/field.html" with field=offer_counter_form.wage_weekly %}
            {% include "components/form/field.html" with field=offer_counter_form.contract_years %}
            {% include "components/form/field.html" with field=offer_counter_form.contract_end_date %}
            {% include "components/form/field.html" with field=offer_counter_form.expires_at %}
            {% include "components/button.html" with text="Send counter" variant="primary" size="sm" extra_classes="w-full" %}
          </form>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
