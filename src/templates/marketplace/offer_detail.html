{% extends "base.html" %}

{% block title %}Offer {{ offer.id }} | TransferX{% endblock %}

{% block content %}
  {% include "components/page_header.html" with title=offer.player.name subtitle="Offer details" %}

  <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
    <div class="space-y-6">
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <div class="text-lg font-semibold text-slate-900">{{ offer.player.name }}</div>
            <div class="text-sm text-slate-500">
              From {{ offer.from_club.club_name }} to {% if offer.to_club %}{{ offer.to_club.club_name }}{% else %}Free agent{% endif %}
            </div>
            <div class="text-xs text-slate-400">Status: {{ offer.get_status_display }}</div>
            <div class="text-xs text-slate-400">You are the {{ role|lower }}</div>
          </div>
          {% include "components/badge.html" with text=offer.get_status_display variant="neutral" size="sm" %}
        </div>
        <div class="mt-4 grid gap-4 sm:grid-cols-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-slate-400">Fee</div>
            <div class="text-sm font-semibold text-slate-900">GBP {{ offer.fee_amount|default:"-" }}</div>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide text-slate-400">Wage (weekly)</div>
            <div class="text-sm font-semibold text-slate-900">GBP {{ offer.wage_weekly|default:"-" }}</div>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide text-slate-400">Contract</div>
            <div class="text-sm font-semibold text-slate-900">
              {% if offer.contract_years %}{{ offer.contract_years }} years{% else %}-{% endif %}
            </div>
          </div>
        </div>
        <div class="mt-4 text-sm text-slate-500">
          {% if offer.expires_at %}Expires {{ offer.expires_at|date:"M d, H:i" }}{% else %}No expiry{% endif %}
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Messages</h2>
        <div class="mt-4 space-y-3">
          {% for message in messages %}
            <div class="rounded-xl border border-slate-100 bg-slate-50 px-4 py-3 text-sm">
              <div class="text-xs text-slate-400">
                {% if message.sender_club %}{{ message.sender_club.club_name }}{% else %}{{ message.sender_user.username }}{% endif %} - {{ message.created_at|date:"M d, H:i" }}
              </div>
              <div class="mt-1 text-slate-700">{{ message.body }}</div>
            </div>
          {% empty %}
            <div class="text-sm text-slate-500">No messages yet.</div>
          {% endfor %}
        </div>

        <form method="post" action="{% url 'marketplace:offer_message' offer.id %}" class="mt-4 space-y-3">
          {% csrf_token %}
          {% include "components/form/field.html" with field=message_form.body %}
          {% include "components/button.html" with text="Send message" variant="secondary" size="sm" %}
        </form>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Timeline</h2>
        <div class="mt-4">
          {% if events %}
            {% include "components/timeline.html" with events=events %}
          {% else %}
            <div class="text-sm text-slate-500">No events yet.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Actions</h2>
        <div class="mt-4 space-y-3">
          {% if club.id == offer.from_club_id %}
            {% if offer.status == "DRAFT" or offer.status == "SENT" or offer.status == "COUNTERED" %}
              <form method="post" action="{% url 'marketplace:offer_withdraw' offer.id %}">
                {% csrf_token %}
                {% include "components/button.html" with text="Withdraw" variant="danger" size="sm" %}
              </form>
            {% endif %}
          {% endif %}

          {% if club.id == offer.to_club_id %}
            {% if offer.status == "SENT" or offer.status == "COUNTERED" %}
              <form method="post" action="{% url 'marketplace:offer_accept' offer.id %}">
                {% csrf_token %}
                {% include "components/button.html" with text="Accept" variant="primary" size="sm" %}
              </form>
              <form method="post" action="{% url 'marketplace:offer_reject' offer.id %}">
                {% csrf_token %}
                {% include "components/button.html" with text="Reject" variant="secondary" size="sm" %}
              </form>
            {% endif %}
          {% endif %}
        </div>
      </div>

      {% if can_scout %}
        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <h2 class="text-lg font-semibold text-slate-900">Scouting</h2>
          <div class="mt-3">
            {% include "scouting/_interest_badge.html" with interest=interest %}
          </div>
          <form method="post" action="{% url 'scouting:interest_set' %}" class="mt-4">
            {% csrf_token %}
            <input type="hidden" name="player_id" value="{{ offer.player.id }}" />
            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
            <input type="hidden" name="level" value="PRIORITY" />
            <input type="hidden" name="stage" value="NEGOTIATING" />
            {% include "components/button.html" with text="Set negotiating" variant="secondary" size="sm" %}
          </form>
          <div class="mt-4 text-xs text-slate-500">Add to shortlist</div>
          {% include "scouting/_shortlist_dropdown.html" with player=offer.player shortlists=shortlists next_url=request.get_full_path can_scout=can_scout %}
        </div>
      {% endif %}

      {% if offer.status == "SENT" or offer.status == "COUNTERED" %}
        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <h2 class="text-lg font-semibold text-slate-900">Counter offer</h2>
          <form method="post" action="{% url 'marketplace:offer_counter' offer.id %}" class="mt-4 space-y-3">
            {% csrf_token %}
            {% include "components/form/field.html" with field=offer_counter_form.fee_amount %}
            {% include "components/form/field.html" with field=offer_counter_form.wage_weekly %}
            {% include "components/form/field.html" with field=offer_counter_form.contract_years %}
            {% include "components/form/field.html" with field=offer_counter_form.contract_end_date %}
            {% include "components/form/field.html" with field=offer_counter_form.expires_at %}
            {% include "components/button.html" with text="Send counter" variant="secondary" size="sm" %}
          </form>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
