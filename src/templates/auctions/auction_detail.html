{% extends "base.html" %}
{% load roles %}

{% block title %}Listing | TransferX{% endblock %}

{% block page_title %}<h1 class="text-2xl font-semibold text-white">{{ auction.player.name }}</h1>{% endblock %}
{% block page_subtitle %}<p class="text-sm text-slate-400">Listing details</p>{% endblock %}
{% block page_actions %}
  <div class="flex items-center gap-2">
    {% include "components/badge.html" with text=auction.get_status_display variant="neutral" size="sm" %}
    {% if reserve_met is not None %}
      {% if reserve_met %}
        {% include "components/badge.html" with text="Reserve met" variant="success" size="sm" %}
      {% else %}
        {% include "components/badge.html" with text="Reserve not met" variant="warning" size="sm" %}
      {% endif %}
    {% endif %}
    {% if player_form and player_form.form_score >= 75 %}
      {% include "components/badge.html" with text="Hot" variant="danger" size="sm" %}
    {% endif %}
  </div>
{% endblock %}

{% block content %}
  <div class="grid gap-6 lg:grid-cols-[3fr_2fr]">
    {# ── Left column: bid ladder + info (60%) ── #}
    <div class="space-y-6">

      {# Player info + stats #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Player</div>
            <div class="mt-1 text-2xl font-bold text-white">{{ auction.player.name }}</div>
            <div class="mt-1 text-sm text-slate-400">
              {{ auction.player.get_position_display|default:"-" }} | Age {{ auction.player.age|default:"-" }}
            </div>
          </div>
        </div>

        <div class="mt-5 grid gap-3 sm:grid-cols-3">
          <div class="rounded-lg bg-slate-800/60 p-3">
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Deadline</div>
            <div class="mt-1 text-sm font-semibold text-white">{{ auction.deadline|date:"M d, H:i" }}</div>
            <div class="mt-1 text-xs text-emerald-400">
              <span id="countdown" data-deadline-iso="{{ auction.deadline|date:"c" }}">--</span>
            </div>
          </div>
          <div class="rounded-lg bg-slate-800/60 p-3">
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Current Best</div>
            <div class="mt-1 text-sm font-semibold text-white">{% if best_bid %}GBP {{ best_bid }}{% else %}-{% endif %}</div>
            <div class="mt-1 text-xs text-slate-500">{{ bid_count }} offers</div>
          </div>
          <div class="rounded-lg bg-slate-800/60 p-3">
            <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Min Next</div>
            <div class="mt-1 text-sm font-semibold text-white">{% if minimum_next %}GBP {{ minimum_next }}{% else %}-{% endif %}</div>
            <div class="mt-1 text-xs text-slate-500">{{ auction.get_status_display }}</div>
          </div>
        </div>

        {# Player form stats #}
        <div class="mt-5 rounded-lg bg-slate-800/40 p-4">
          <div class="text-sm font-semibold text-white">Player form</div>
          {% if player_form %}
            <div class="mt-3 grid gap-3 sm:grid-cols-3">
              <div>
                <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Score</div>
                <div class="text-sm font-semibold text-white">{{ player_form.form_score|floatformat:1 }}</div>
              </div>
              <div>
                <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Avg rating</div>
                <div class="text-sm font-semibold text-white">{{ player_form.avg_rating|default:"-" }}</div>
              </div>
              <div>
                <div class="text-xs font-medium uppercase tracking-wider text-slate-500">Goals / assists</div>
                <div class="text-sm font-semibold text-white">{{ player_form.goals|default:"0" }} / {{ player_form.assists|default:"0" }}</div>
              </div>
            </div>
          {% else %}
            <div class="mt-2 text-sm text-slate-500">No form available yet.</div>
          {% endif %}
          <div class="mt-3 text-xs text-slate-600">
            Updated: {% if latest_snapshot %}{{ latest_snapshot.as_of|date:"M d, H:i" }}{% else %}-{% endif %}
          </div>
        </div>
      </div>

      {# Offer ladder #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white">Offer ladder</h2>
          <span class="text-xs text-slate-500">Auto refreshes</span>
        </div>
        <div
          id="bid-ladder"
          class="mt-4"
          hx-get="{% url 'auctions:bids_partial' auction.id %}"
          hx-trigger="load, every 5s"
          hx-swap="innerHTML"
        >
          {% include "auctions/_bid_ladder.html" with bids=bid_ladder best_bid=best_bid minimum_next=minimum_next reserve_met=reserve_met %}
        </div>
      </div>

      {# Timeline #}
      <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white">Timeline</h2>
          <span class="text-xs text-slate-500">Most recent at the bottom</span>
        </div>
        <div class="mt-4">
          {% if events %}
            {% include "components/timeline.html" with events=events %}
          {% else %}
            <div class="text-sm text-slate-500">No events yet.</div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ── Right column: place offer + seller controls (40%) ── #}
    <div class="space-y-6 lg:sticky lg:top-6 lg:self-start">
      {% if user|user_is_buyer %}
        <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">Place an offer</h2>
            {% if auction.status != 'OPEN' %}
              {% include "components/badge.html" with text="Closed" variant="neutral" size="sm" %}
            {% endif %}
          </div>

          {% if not can_bid %}
            <div class="mt-3 rounded-lg bg-slate-800/60 px-3 py-2 text-sm text-slate-400">
              Offers are closed or you cannot make an offer on this listing.
            </div>
          {% endif %}

          {% if buyer_active_bid and best_bid and buyer_active_bid.amount < best_bid %}
            <div class="mt-3 rounded-lg bg-amber-400/10 px-3 py-2 text-sm text-amber-400 ring-1 ring-amber-400/30">
              You have been outbid. Current best offer is GBP {{ best_bid }}.
            </div>
          {% endif %}

          {% if finance %}
            <div class="mt-4 space-y-1">
              {% include "components/metric.html" with label="Transfer remaining" value="GBP "|add:finance.transfer_remaining %}
              {% include "components/metric.html" with label="Wage remaining (weekly)" value="GBP "|add:finance.wage_remaining_weekly %}
            </div>
          {% endif %}

          <div class="mt-4 space-y-1">
            {% include "components/metric.html" with label="Current best offer" value=best_bid|default:"-" %}
            {% include "components/metric.html" with label="Minimum next offer" value=minimum_next|default:"-" %}
          </div>

          <form class="mt-4 space-y-4" method="post" action="{% url 'auctions:place_bid' auction.id %}">
            {% csrf_token %}
            {% include "components/form/error_summary.html" with form=bid_form %}
            {% include "components/form/field.html" with field=bid_form.amount %}
            {% include "components/form/field.html" with field=bid_form.wage_offer_weekly help_text="Weekly wage offer for the player." %}
            {% if bid_form.notes %}
              {% include "components/form/field.html" with field=bid_form.notes help_text="Optional note to the seller." %}
            {% endif %}

            {% if auction.status == 'OPEN' and can_bid %}
              {% include "components/button.html" with text="Submit offer" variant="primary" size="md" extra_classes="w-full" %}
            {% else %}
              <button type="button" class="inline-flex w-full items-center justify-center rounded-lg bg-slate-800 px-4 py-2 text-sm font-medium text-slate-500" disabled>
                Offers closed
              </button>
            {% endif %}
          </form>
        </div>
      {% endif %}

      {% if is_owner %}
        {% url 'auctions:bids_csv' auction.id as bids_csv_url %}
        <div class="rounded-xl bg-slate-900 p-6 ring-1 ring-white/[0.08]">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">Seller controls</h2>
            {% include "components/button.html" with text="Export CSV" href=bids_csv_url variant="secondary" size="sm" %}
          </div>

          <div class="mt-3 space-y-1">
            {% if auction.reserve_price %}
              {% include "components/metric.html" with label="Reserve price" value=auction.reserve_price %}
            {% endif %}
            {% if reserve_met is not None %}
              <div class="flex items-center justify-between text-sm">
                <span class="text-slate-400">Reserve met</span>
                <span class="font-semibold text-white">{% if reserve_met %}Yes{% else %}No{% endif %}</span>
              </div>
            {% endif %}
            {% include "components/metric.html" with label="Total offers" value=bid_count %}
            {% include "components/metric.html" with label="Offer velocity" value=bids_per_hour %}
          </div>

          <div
            id="seller-bids"
            class="mt-4"
            hx-get="{% url 'auctions:seller_bids_partial' auction.id %}"
            hx-trigger="load, every 5s"
            hx-swap="innerHTML"
          >
            {% include "auctions/_seller_bid_table.html" with bids=seller_bids auction=auction %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      const countdown = document.getElementById("countdown");
      if (!countdown) return;
      const deadlineIso = countdown.dataset.deadlineIso;
      if (!deadlineIso) return;
      const deadline = new Date(deadlineIso).getTime();

      function updateCountdown() {
        const now = Date.now();
        const diff = deadline - now;
        if (diff <= 0) {
          countdown.textContent = "Ended";
          return;
        }
        const totalSeconds = Math.floor(diff / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        countdown.textContent = `${hours}h ${minutes}m ${seconds}s`;
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();
  </script>
{% endblock %}
